<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FieldAgent - History</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen pb-16">
    <!-- Top Navigation -->
    <nav class="bg-white shadow-md px-4 py-3 sticky top-0 z-10">
        <div class="flex justify-between items-center">
            <div class="flex items-center">
                <button id="menuToggle" class="mr-4 text-gray-600 focus:outline-none">
                    <i class="fas fa-bars text-lg"></i>
                </button>
                <h1 class="text-xl font-bold text-indigo-600">FieldAgent</h1>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <button id="notificationBtn" class="text-gray-600 focus:outline-none">
                        <i class="fas fa-bell text-lg"></i>
                        <span class="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">3</span>
                    </button>
                </div>
                <div class="h-8 w-8 rounded-full bg-indigo-200 flex items-center justify-center text-indigo-700 font-semibold cursor-pointer" id="profileDropdown">
                    JS
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Sidebar Menu (Hidden by default on mobile) -->
    <div id="sidebar" class="fixed inset-y-0 left-0 bg-white w-64 shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out z-20">
        <div class="p-4 border-b">
            <div class="flex items-center">
                <div class="h-10 w-10 rounded-full bg-indigo-200 flex items-center justify-center text-indigo-700 font-semibold mr-3">
                    JS
                </div>
                <div>
                    <h2 class="text-lg font-semibold" id="agentName">John Smith</h2>
                    <p class="text-sm text-gray-600" id="agentId">Agent #A12345</p>
                </div>
            </div>
        </div>
        <nav class="mt-4">
            <a th:href="@{/agent/dashboard}" class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-100">
                <i class="fas fa-th-large w-6"></i>
                <span>Dashboard</span>
            </a>
            <a th:href="@{/agent/activeRoute}" class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-100">
                <i class="fas fa-route w-6"></i>
                <span>Active Route</span>
            </a>
            <a th:href="@{/agent/customers}" class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-100">
                <i class="fas fa-users w-6"></i>
                <span>Customers</span>
            </a>
            <a th:href="@{agent/collection}" class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-100">
                <i class="fas fa-money-bill-wave w-6"></i>
                <span>Collections</span>
            </a>
            <a th:href="@{/agent/history}" class="flex items-center px-4 py-3 text-indigo-600 bg-indigo-50 border-l-4 border-indigo-600">
                <i class="fas fa-history w-6"></i>
                <span>History</span>
            </a>
            <a th:href ="@{/agent/settings}" class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-100">
                <i class="fas fa-cog w-6"></i>
                <span>Settings</span>
            </a>
        </nav>
        <div class="absolute bottom-0 w-full border-t p-4">
            <button id="logoutBtn" class="w-full flex items-center justify-center px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg">
                <i class="fas fa-sign-out-alt mr-2"></i>
                <span>Logout</span>
            </button>
        </div>
    </div>
    
    <!-- Overlay for sidebar -->
    <div id="overlay" class="fixed inset-0 bg-black opacity-0 pointer-events-none transition-opacity duration-300 ease-in-out z-10"></div>
    
    <!-- Main Content -->
    <div class="container mx-auto px-4 py-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">Activity History</h2>
            <div class="flex space-x-2">
                <div class="relative">
                    <select id="activityFilter" class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 appearance-none bg-white">
                        <option value="all">All Activities</option>
                        <option value="routes">Routes</option>
                        <option value="visits">Visits</option>
                        <option value="collections">Collections</option>
                    </select>
                    <i class="fas fa-filter absolute left-3 top-3 text-gray-400"></i>
                </div>
                <button id="calendarBtn" class="px-4 py-2 border rounded-lg bg-white hover:bg-gray-50">
                    <i class="fas fa-calendar-alt text-gray-600"></i>
                </button>
            </div>
        </div>
        
        <!-- Calendar (collapsed by default) -->
        <div id="calendarView" class="bg-white rounded-xl shadow-md p-4 mb-6 hidden">
            <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-600 border-b pb-2 mb-2">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center">
                <!-- This would be dynamically generated in a real app -->
                <div class="p-2 text-gray-400">30</div>
                <div class="p-2 text-gray-400">31</div>
                <div class="p-2">1</div>
                <div class="p-2">2</div>
                <div class="p-2">3</div>
                <div class="p-2 bg-indigo-50">4
                    <div class="mt-1 h-1 w-1 rounded-full bg-green-500 mx-auto"></div>
                </div>
                <div class="p-2 bg-indigo-50">5
                    <div class="mt-1 h-1 w-1 rounded-full bg-green-500 mx-auto"></div>
                </div>
                <div class="p-2 bg-indigo-50">6
                    <div class="mt-1 h-1 w-1 rounded-full bg-green-500 mx-auto"></div>
                </div>
                <div class="p-2 bg-indigo-50">7
                    <div class="mt-1 h-1 w-1 rounded-full bg-green-500 mx-auto"></div>
                </div>
                <div class="p-2 bg-indigo-100 ring-2 ring-indigo-600 rounded-lg">8
                    <div class="mt-1 h-1 w-1 rounded-full bg-green-500 mx-auto"></div>
                </div>
                <div class="p-2">9</div>
                <div class="p-2">10</div>
                <div class="p-2">11</div>
                <div class="p-2">12</div>
                <div class="p-2">13</div>
                <div class="p-2">14</div>
                <div class="p-2">15</div>
                <div class="p-2">16</div>
                <div class="p-2">17</div>
                <div class="p-2">18</div>
                <div class="p-2">19</div>
                <div class="p-2">20</div>
                <div class="p-2">21</div>
                <div class="p-2">22</div>
                <div class="p-2">23</div>
                <div class="p-2">24</div>
                <div class="p-2">25</div>
                <div class="p-2">26</div>
                <div class="p-2">27</div>
                <div class="p-2">28</div>
                <div class="p-2">29</div>
                <div class="p-2">30</div>
                <div class="p-2 text-gray-400">1</div>
                <div class="p-2 text-gray-400">2</div>
                <div class="p-2 text-gray-400">3</div>
            </div>
            <div class="mt-2 text-center">
                <p class="text-sm text-gray-600">Green dot indicates activity on that day</p>
            </div>
        </div>
        
        <!-- Activity List -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <!-- Today Section -->
            <div class="px-4 py-2 bg-gray-50 text-sm font-medium text-gray-600">Today - April 8, 2025</div>
            <div class="divide-y">
                <!-- Route Activity -->
                <div class="p-4 hover:bg-gray-50 transition-colors duration-200">
                    <div class="flex items-start">
                        <div class="bg-indigo-100 rounded-full p-2 mr-3">
                            <i class="fas fa-route text-indigo-600"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <h4 class="font-medium">Route Started</h4>
                                <span class="text-sm text-gray-500">8:00 AM</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">Daily route started with 12 scheduled visits</p>
                        </div>
                    </div>
                </div>
                
                <!-- Visit Activity -->
                <div class="p-4 hover:bg-gray-50 transition-colors duration-200">
                    <div class="flex items-start">
                        <div class="bg-blue-100 rounded-full p-2 mr-3">
                            <i class="fas fa-clipboard-check text-blue-600"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <h4 class="font-medium">Customer Visit</h4>
                                <span class="text-sm text-gray-500">9:30 AM</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">Visit to ABC Company completed</p>
                            <div class="mt-2 text-sm">
                                <button class="text-indigo-600 hover:underline">View Details</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Yesterday Section -->
            <div class="px-4 py-2 bg-gray-50 text-sm font-medium text-gray-600">Yesterday - April 7, 2025</div>
            <div class="divide-y">
                <!-- Route Activity -->
                <div class="p-4 hover:bg-gray-50 transition-colors duration-200">
                    <div class="flex items-start">
                        <div class="bg-indigo-100 rounded-full p-2 mr-3">
                            <i class="fas fa-route text-indigo-600"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <h4 class="font-medium">Route Started</h4>
                                <span class="text-sm text-gray-500">8:15 AM</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">Daily route started with 10 scheduled visits</p>
                        </div>
                    </div>
                </div>
                
                <!-- Collection Activity -->
                <div class="p-4 hover:bg-gray-50 transition-colors duration-200">
                    <div class="flex items-start">
                        <div class="bg-green-100 rounded-full p-2 mr-3">
                            <i class="fas fa-hand-holding-usd text-green-600"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <h4 class="font-medium">Collection Recorded</h4>
                                <span class="text-sm text-gray-500">10:42 AM</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">$875.50 collected from XYZ Corporation</p>
                            <div class="mt-2 text-sm">
                                <button class="text-indigo-600 hover:underline">View Receipt</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Collection Activity -->
                <div class="p-4 hover:bg-gray-50 transition-colors duration-200">
                    <div class="flex items-start">
                        <div class="bg-green-100 rounded-full p-2 mr-3">
                            <i class="fas fa-hand-holding-usd text-green-600"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <h4 class="font-medium">Collection Recorded</h4>
                                <span class="text-sm text-gray-500">3:15 PM</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">$1,250.00 collected from 123 Industries</p>
                            <div class="mt-2 text-sm">
                                <button class="text-indigo-600 hover:underline">View Receipt</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Route Activity -->
                <div class="p-4 hover:bg-gray-50 transition-colors duration-200">
                    <div class="flex items-start">
                        <div class="bg-red-100 rounded-full p-2 mr-3">
                            <i class="fas fa-stop-circle text-red-600"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <h4 class="font-medium">Route Ended</h4>
                                <span class="text-sm text-gray-500">5:30 PM</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">Daily route completed with 8/10 visits completed</p>
                            <div class="mt-2 text-sm">
                                <button class="text-indigo-600 hover:underline">View Summary</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Previous Section -->
            <div class="px-4 py-2 bg-gray-50 text-sm font-medium text-gray-600">April 6, 2025</div>
            <div class="divide-y">
                <!-- Visit Activity -->
                <div class="p-4 hover:bg-gray-50 transition-colors duration-200">
                    <div class="flex items-start">
                        <div class="bg-blue-100 rounded-full p-2 mr-3">
                            <i class="fas fa-clipboard-check text-blue-600"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <h4 class="font-medium">Customer Visit</h4>
                                <span class="text-sm text-gray-500">11:30 AM</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">Visit to Global Solutions Inc. completed</p>
                            <div class="mt-2 text-sm">
                                <button class="text-indigo-600 hover:underline">View Details</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Load More Button -->
            <div class="p-4 text-center">
                <button id="loadMoreBtn" class="px-4 py-2 text-indigo-600 hover:text-indigo-800">
                    Load More <i class="fas fa-chevron-down ml-1"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 inset-x-0 bg-white border-t shadow-lg z-10">
        <div class="flex justify-around">
            <a th:href="@{/agent/dashboard}" class="flex flex-col items-center py-2 flex-1 text-gray-500">
                <i class="fas fa-th-large text-lg"></i>
                <span class="text-xs mt-1">Dashboard</span>
            </a>
            <a th:href="@{/agent/activeRoute}" class="flex flex-col items-center py-2 flex-1 text-gray-500">
                <i class="fas fa-route text-lg"></i>
                <span class="text-xs mt-1">Route</span>
            </a>
            <a th:href="@{/agent/visit}" class="flex flex-col items-center py-2 flex-1 text-gray-500">
                <i class="fas fa-clipboard-check text-lg"></i>
                <span class="text-xs mt-1">Visit</span>
            </a>
            <a th:href="@{/agent/collection}" class="flex flex-col items-center py-2 flex-1 text-gray-500">
                <i class="fas fa-hand-holding-usd text-lg"></i>
                <span class="text-xs mt-1">Collect</span>
            </a>
            <a th:href="@{/agent/more}" class="flex flex-col items-center py-2 flex-1 text-gray-500">
                <i class="fas fa-ellipsis-h text-lg"></i>
                <span class="text-xs mt-1">More</span>
            </a>
        </div>
    </nav>

    <script>        
// Complete the JavaScript for the history page
document.addEventListener('DOMContentLoaded', function() {
    // Sidebar toggle functionality
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    
    menuToggle.addEventListener('click', function() {
        sidebar.classList.toggle('-translate-x-full');
        overlay.classList.toggle('opacity-0');
        overlay.classList.toggle('pointer-events-none');
    });
    
    overlay.addEventListener('click', function() {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('opacity-0');
        overlay.classList.add('pointer-events-none');
    });
    
    // Calendar toggle
    const calendarBtn = document.getElementById('calendarBtn');
    const calendarView = document.getElementById('calendarView');
    
    calendarBtn.addEventListener('click', function() {
        calendarView.classList.toggle('hidden');
    });
    
    // Activity filter functionality
    const activityFilter = document.getElementById('activityFilter');
    const activityItems = document.querySelectorAll('.p-4.hover\\:bg-gray-50');
    
    activityFilter.addEventListener('change', function() {
        const selectedValue = this.value;
        
        activityItems.forEach(item => {
            const iconElement = item.querySelector('i');
            
            if (selectedValue === 'all') {
                item.style.display = 'block';
                return;
            }
            
            // Check the icon class to determine the activity type
            if (selectedValue === 'routes' && iconElement.classList.contains('fa-route')) {
                item.style.display = 'block';
            } else if (selectedValue === 'visits' && iconElement.classList.contains('fa-clipboard-check')) {
                item.style.display = 'block';
            } else if (selectedValue === 'collections' && iconElement.classList.contains('fa-hand-holding-usd')) {
                item.style.display = 'block';
            } else if (selectedValue === 'routes' && iconElement.classList.contains('fa-stop-circle')) {
                item.style.display = 'block'; // Include route ended in routes filter
            } else {
                item.style.display = 'none';
            }
        });
    });
    
    // Load more functionality
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    let page = 1;
    
    loadMoreBtn.addEventListener('click', function() {
        // Show loading state
        this.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Loading...';
        
        // Fetch more history data
        fetchHistoryData(page + 1)
            .then(data => {
                if (data && data.length > 0) {
                    displayHistoryData(data);
                    page++;
                } else {
                    // No more data
                    this.innerHTML = 'No more activities';
                    this.disabled = true;
                    this.classList.add('text-gray-400');
                    this.classList.remove('text-indigo-600', 'hover:text-indigo-800');
                }
            })
            .catch(error => {
                console.error('Error fetching history data:', error);
                this.innerHTML = 'Error loading data. Try again.';
            })
            .finally(() => {
                if (!this.disabled) {
                    this.innerHTML = 'Load More <i class="fas fa-chevron-down ml-1"></i>';
                }
            });
    });
});

// Function to fetch history data from the backend
async function fetchHistoryData(page = 1, filter = 'all') {
    try {
        const response = await fetch(`/api/history?page=${page}&filter=${filter}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('Error fetching history data:', error);
        return [];
    }
}

// Function to display history data in the UI
function displayHistoryData(historyItems) {
    const activityList = document.querySelector('.bg-white.rounded-xl.shadow-md.overflow-hidden');
    
    // Group items by date
    const groupedByDate = {};
    
    historyItems.forEach(item => {
        const dateStr = formatDate(new Date(item.timestamp));
        if (!groupedByDate[dateStr]) {
            groupedByDate[dateStr] = [];
        }
        groupedByDate[dateStr].push(item);
    });
    
    // Create and append elements for each date group
    for (const [dateStr, items] of Object.entries(groupedByDate)) {
        // Check if date section already exists
        let dateSection = Array.from(activityList.querySelectorAll('.px-4.py-2.bg-gray-50')).find(
            el => el.textContent === dateStr
        );
        
        if (!dateSection) {
            // Create date header
            dateSection = document.createElement('div');
            dateSection.className = 'px-4 py-2 bg-gray-50 text-sm font-medium text-gray-600';
            dateSection.textContent = dateStr;
            
            // Create container for items
            const itemsContainer = document.createElement('div');
            itemsContainer.className = 'divide-y';
            
            // Add date header and container before the "Load More" button
            activityList.insertBefore(dateSection, document.getElementById('loadMoreBtn').parentElement);
            activityList.insertBefore(itemsContainer, document.getElementById('loadMoreBtn').parentElement);
        } else {
            // Find the corresponding items container
            dateSection = dateSection.nextElementSibling;
        }
        
        // Add items to the container
        items.forEach(item => {
            const activityElement = createActivityElement(item);
            dateSection.appendChild(activityElement);
        });
    }
}

// Function to create an activity element
function createActivityElement(activity) {
    const div = document.createElement('div');
    div.className = 'p-4 hover:bg-gray-50 transition-colors duration-200';
    
    let iconClass, bgColorClass, textColorClass;
    
    // Set icon and colors based on activity type
    switch (activity.type) {
        case 'route_start':
            iconClass = 'fas fa-route';
            bgColorClass = 'bg-indigo-100';
            textColorClass = 'text-indigo-600';
            break;
        case 'route_end':
            iconClass = 'fas fa-stop-circle';
            bgColorClass = 'bg-red-100';
            textColorClass = 'text-red-600';
            break;
        case 'visit':
            iconClass = 'fas fa-clipboard-check';
            bgColorClass = 'bg-blue-100';
            textColorClass = 'text-blue-600';
            break;
        case 'collection':
            iconClass = 'fas fa-hand-holding-usd';
            bgColorClass = 'bg-green-100';
            textColorClass = 'text-green-600';
            break;
        default:
            iconClass = 'fas fa-info-circle';
            bgColorClass = 'bg-gray-100';
            textColorClass = 'text-gray-600';
    }
    
    div.innerHTML = `
        <div class="flex items-start">
            <div class="${bgColorClass} rounded-full p-2 mr-3">
                <i class="${iconClass} ${textColorClass}"></i>
            </div>
            <div class="flex-1">
                <div class="flex justify-between">
                    <h4 class="font-medium">${activity.title}</h4>
                    <span class="text-sm text-gray-500">${formatTime(new Date(activity.timestamp))}</span>
                </div>
                <p class="text-sm text-gray-600 mt-1">${activity.description}</p>
                ${activity.hasDetails ? `
                <div class="mt-2 text-sm">
                    <button class="text-indigo-600 hover:underline" data-id="${activity.id}">
                        View ${activity.type === 'collection' ? 'Receipt' : 'Details'}
                    </button>
                </div>` : ''}
            </div>
        </div>
    `;
    
    // Add event listener for the detail button if it exists
    const detailButton = div.querySelector('button[data-id]');
    if (detailButton) {
        detailButton.addEventListener('click', function() {
            const activityId = this.getAttribute('data-id');
            viewActivityDetails(activityId, activity.type);
        });
    }
    
    return div;
}

// Function to view activity details
async function viewActivityDetails(activityId, type) {
    try {
        const response = await fetch(`/api/activity/${activityId}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Here you would open a modal or navigate to a details page
        // For now, just log the data
        console.log('Activity details:', data);
        
        // Example of redirecting to a details page
        if (type === 'collection') {
            // window.location.href = `/receipt.html?id=${activityId}`;
            // TODO: Implement receipt page
        } else if (type === 'visit') {
            window.location.href = `/agent/visit?id=${activityId}`;
        } else if (type === 'route_end') {
            window.location.href = `/agent/routeSummary?id=${activityId}`;
        }
    } catch (error) {
        console.error('Error fetching activity details:', error);
        alert('Failed to load activity details. Please try again.');
    }
}

// Helper function to format date
function formatDate(date) {
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (date.toDateString() === today.toDateString()) {
        return 'Today - ' + date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    } else if (date.toDateString() === yesterday.toDateString()) {
        return 'Yesterday - ' + date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    } else {
        return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    }
}

// Helper function to format time
function formatTime(date) {
    return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
}